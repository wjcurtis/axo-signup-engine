<!doctype html>

<html lang="en">

<head>

<meta charset="utf-8"/>

<meta name="viewport" content="width=device-width,initial-scale=1"/>

<title>AXO Admin</title>

<style>

:root{--bg:#0f172a;--panel:#111827;--text:#e5e7eb;--muted:#9ca3af;--accent:#2563eb}

*{box-sizing:border-box}

body{margin:0;background:radial-gradient(1200px 600px at 50% -10%,#33415533,transparent),var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial}

.wrap{max-width:1100px;margin:40px auto;padding:20px}

.card{background:var(--panel);border-radius:14px;padding:22px;box-shadow:0 12px 30px #0007;border:1px solid #1f2937}

h1{margin:0 0 16px;font-size:28px;letter-spacing:.4px}

h2{margin:24px 0 8px;font-size:16px;color:#cbd5e1}

.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}

label{display:block;font-size:13px;color:var(--muted);margin:0 0 6px}

input,select,textarea{width:100%;padding:12px 14px;border:1px solid #374151;border-radius:10px;background:#0b1220;color:var(--text);outline:none}

textarea{min-height:82px;resize:vertical}

.row{margin:10px 0}

.actions{display:flex;gap:12px;justify-content:flex-end;margin-top:18px}

button{padding:10px 16px;border-radius:10px;border:1px solid #2a3a6a;background:#101936;color:#cbd5e1;cursor:pointer}

button.primary{background:linear-gradient(180deg,#3b82f6,#2563eb);border-color:#2b50a8;color:white}

.pin{max-width:420px;margin:80px auto 0}

.pin h2{font-weight:600;font-size:22px;margin:0 0 10px}

.hint{color:#94a3b8;font-size:13px;margin-top:6px}

.ok{color:#10b981}.err{color:#f87171}

.kv{display:grid;grid-template-columns:200px 1fr;gap:10px;align-items:center}

.kv input{width:100%}

/* small helpers */

.small{font-size:12px;color:#9ca3af}

.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}

</style>

</head>

<body>

<div class="wrap">

  <!-- PIN Card -->

  <div id="pinCard" class="card pin" style="display:none">

    <h2>Enter Admin PIN</h2>

    <div class="row">

      <label for="pin">PIN</label>

      <input id="pin" type="password" placeholder="••••••"/>

    </div>

    <div class="actions">

      <button onclick="login()">Unlock</button>

      <button onclick="goHome()">Back</button>

    </div>

    <div id="pinMsg" class="hint"></div>

  </div>



  <!-- Admin Card -->

  <div id="adminCard" class="card" style="display:none">

    <h1>AXO Admin</h1>



    <!-- Live Market (NEW, auto‑refresh every 30s) -->

    <h2>Live Market</h2>

    <div class="grid" style="grid-template-columns:repeat(3,1fr)">

      <div>

        <label>XRP Price (USD)</label>

        <div id="xrpPrice" class="mono">$—</div>

      </div>

      <div>

        <label>AXO Price (USD, static)</label>

        <div id="axoPrice" class="mono">$0.01</div>

      </div>

      <div>

        <label>1 XRP =</label>

        <div id="ratio" class="mono">— AXO</div>

      </div>

    </div>

    <div class="small" style="margin-top:6px">Source: <span id="marketSource">—</span> · Updated <span id="marketTime">—</span></div>



    <!-- Incentives -->

    <h2>Incentives</h2>

    <div class="grid">

      <div><label>Signup Bonus (AXO)</label><input id="signup_bonus" type="number" min="0" step="1"></div>

      <div><label>Referral Reward (AXO)</label><input id="referral_reward" type="number" min="0" step="1"></div>

      <div>

        <label>Require TrustLine</label>

        <select id="require_trustline"><option>true</option><option>false</option></select>

      </div>

    </div>



    <!-- Pricing -->

    <h2>Pricing & Flow</h2>

    <div class="grid">

      <div><label>AXO Price (USD, static)</label><input id="axo_price_usd" type="number" min="0" step="0.0001"></div>

      <div><label>Buy Flow Enabled</label><select id="buy_enabled"><option>true</option><option>false</option></select></div>

      <div><label>Quick Signup Enabled</label><select id="quick_signup_enabled"><option>false</option><option>true</option></select></div>

    </div>



    <!-- Fees / Vault -->

    <h2>Fees & Vault</h2>

    <div class="grid">

      <div><label>Flat Fee (XRP) per claim</label><input id="fee_xrp" type="number" min="0" step="0.000001"></div>

      <div class="kv"><label>Vault Address (r-...)</label><input id="vault_addr" placeholder="r........"/></div>

      <div></div>

    </div>



    <!-- Abuse & Limits -->

    <h2>Abuse & Limits</h2>

    <div class="grid">

      <div><label>Daily Cap (AXO)</label><input id="daily_cap_axo" type="number" min="0" step="1"></div>

      <div><label>Max Claims / Wallet</label><input id="max_claims_per_wallet" type="number" min="1" step="1"></div>

      <div><label>Claims / Hour (rate‑limit)</label><input id="rate_limit_claims_per_hour" type="number" min="1" step="1"></div>

    </div>

    <div class="grid" style="margin-top:10px">

      <div class="row">

        <label>Whitelist (comma r-...)</label>

        <textarea id="whitelist_addresses" placeholder="r...., r...."></textarea>

      </div>

      <div class="row">

        <label>Blacklist (comma r-...)</label>

        <textarea id="blacklist_addresses" placeholder="r...., r...."></textarea>

      </div>

      <div>

        <label>Airdrop Paused</label>

        <select id="airdrop_paused"><option>false</option><option>true</option></select>

        <div class="row"></div>

        <label>Maintenance Mode</label>

        <select id="maintenance_mode"><option>false</option><option>true</option></select>

      </div>

    </div>



    <div class="actions">

      <!-- Close will log out and send you home so next entry asks for PIN -->

      <button onclick="logoutAndHome()">Close</button>

      <!-- Save will save, then log out and send you home -->

      <button class="primary" onclick="saveAndExit()">Save</button>

    </div>

    <div id="msg" class="hint"></div>

  </div>

</div>



<script>

function goHome(){ location.href = '/'; }



async function isAuthed(){

  const r = await fetch('/api/admin/config');

  return r.status === 200;

}



async function show(){

  if(await isAuthed()){ await load(); adminCard.style.display=''; }

  else { pinCard.style.display=''; }

}



async function login(){

  const pin = document.getElementById('pin').value.trim();

  const r = await fetch('/api/admin/login',{

    method:'POST', headers:{'Content-Type':'application/json'},

    body: JSON.stringify({pin})

  });

  const m = document.getElementById('pinMsg');

  if(r.ok){ m.textContent='Unlocked.'; m.className='hint ok'; location.reload(); }

  else   { m.textContent='Invalid PIN.'; m.className='hint err'; }

}



async function logout(){

  // Clears the admin cookie on the server

  await fetch('/api/admin/logout',{method:'POST'});

}



async function logoutAndHome(){

  await logout();

  goHome();

}



async function saveAndExit(){

  const ok = await save(true);   // true = silent (no inline message)

  // Regardless of save success, we log out to enforce re‑prompt next time.

  await logout();

  goHome();

}



async function load(){

  // fill admin config

  const r = await fetch('/api/admin/config');

  if(!r.ok) return;

  const s = (await r.json()).data || {};

  for (const k of [

    'signup_bonus','referral_reward','require_trustline',

    'axo_price_usd','buy_enabled','quick_signup_enabled',

    'fee_xrp','vault_addr',

    'daily_cap_axo','max_claims_per_wallet','rate_limit_claims_per_hour',

    'whitelist_addresses','blacklist_addresses',

    'airdrop_paused','maintenance_mode'

  ]) {

    const el = document.getElementById(k);

    if(!el) continue;

    if (el.tagName==='SELECT') el.value = String(s[k]);

    else if (el.tagName==='TEXTAREA') el.value = (s[k]||[]).join(', ');

    else el.value = s[k] ?? '';

  }



  // initial market refresh right after admin loads

  refreshMarket();

}



async function save(silent=false){

  const body = {};

  const v = id => document.getElementById(id).value;



  body.signup_bonus = Number(v('signup_bonus')||0);

  body.referral_reward = Number(v('referral_reward')||0);

  body.require_trustline = (v('require_trustline')==='true');



  body.axo_price_usd = Number(v('axo_price_usd')||0.01);

  body.buy_enabled = (v('buy_enabled')==='true');

  body.quick_signup_enabled = (v('quick_signup_enabled')==='true');



  body.fee_xrp = Number(v('fee_xrp')||0);

  body.vault_addr = v('vault_addr').trim();



  body.daily_cap_axo = Number(v('daily_cap_axo')||0);

  body.max_claims_per_wallet = Number(v('max_claims_per_wallet')||1);

  body.rate_limit_claims_per_hour = Number(v('rate_limit_claims_per_hour')||1);



  body.whitelist_addresses = v('whitelist_addresses');

  body.blacklist_addresses = v('blacklist_addresses');

  body.airdrop_paused = (v('airdrop_paused')==='true');

  body.maintenance_mode = (v('maintenance_mode')==='true');



  const r = await fetch('/api/admin/config',{

    method:'POST', headers:{'Content-Type':'application/json'},

    body: JSON.stringify(body)

  });



  if (silent) return r.ok;



  const el = document.getElementById('msg');

  el.textContent = r.ok ? 'Saved.' : 'Save failed';

  el.className = 'hint ' + (r.ok?'ok':'err');

  return r.ok;

}



/* ====== Live Market auto-refresh (NEW) ====== */

async function refreshMarket() {

  try {

    const r = await fetch('/api/market', { cache: 'no-store' });

    if (!r.ok) return;

    const j = await r.json();

    const $ = (id) => document.getElementById(id);

    if ($('xrpPrice'))    $('xrpPrice').textContent     = j.xrp_usd ? `$${j.xrp_usd}` : '—';

    if ($('axoPrice'))    $('axoPrice').textContent     = j.axo_usd ? `$${j.axo_usd}` : '—';

    if ($('ratio'))       $('ratio').textContent        = j.axo_per_xrp ? `${Math.floor(j.axo_per_xrp)} AXO` : '—';

    if ($('marketSource'))$('marketSource').textContent = j.source || '';

    if ($('marketTime'))  $('marketTime').textContent   = new Date((j.ts||0)*1000).toLocaleTimeString();

  } catch (e) {

    // ignore; try again on next tick

  }

}

// run immediately and then every 30 seconds

refreshMarket();

setInterval(refreshMarket, 30_000);



/* ====== Init ====== */

const pinCard = document.getElementById('pinCard');

const adminCard = document.getElementById('adminCard');

show();

</script>

</body>

</html>
